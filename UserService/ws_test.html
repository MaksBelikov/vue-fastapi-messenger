<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Передача данных в JS</title>
</head>
<body>
    <h1>Введите данные:</h1>
    
    <div>
        <label for="token">Token:</label>
        <input type="text" id="token">
    </div>
    <button id="submitBtn">Запустить WebSocket</button>
    
    <script>
        class ChatWebSocket {
            constructor(token) {
                this.token = token;
                this.ws = null;
                this.connect();
            }

            connect() {
                this.ws = new WebSocket(`ws://127.0.0.1:8002/online?token=${this.token}`);

                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    this.keepAlive = setInterval(() => this.ws.send('ping'), 30000);
                };

                this.ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    this.handleMessage(message);
                };

                this.ws.onclose = (event) => {
                    console.log('WebSocket disconnected:', event.reason);
                    clearInterval(this.keepAlive);
                    setTimeout(() => this.connect(), 3000);
                };
            }

            handleMessage(message) {
                switch (message.type) {
                    case 'new_message':
                        console.log('New message:', message.data);
                        alert(message.data)
                        break;
                        
                    case 'message_read':
                        console.log('Message read:', message.data);
                        alert(message.data)
                        break;
                        
                    case 'user_typing':
                        console.log('User typing:', message.data);
                        alert(message.data)
                        break;
                        
                    case 'user_online':
                        console.log('User online:', message.data);
                        alert(message.data)
                        break;
                        
                    default:
                        console.warn('Unknown message type:', message.type);
                }
            }

            disconnect() {
                if (this.ws) {
                    this.ws.close();
                }
            }
        }

        document.getElementById('submitBtn').addEventListener('click', function() {
            let token = document.getElementById('token').value;
            
            if(!token.trim()) {
                alert("Заполните оба поля!");
                return;
            }
             new ChatWebSocket(token);
           });
    </script>
</body>
</html>